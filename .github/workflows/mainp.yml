name: Kernel Build Exynos 9830 FAST (LLVM 14 – FINAL)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # =========================
      # CHECKOUT
      # =========================
      - name: Checkout kernel source
        uses: actions/checkout@v4

      # =========================
      # CACHE
      # =========================
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ github.ref }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Restore kernel build output (out/)
        uses: actions/cache@v4
        with:
          path: out
          key: kernel-out-${{ runner.os }}-${{ github.ref }}
          restore-keys: |
            kernel-out-${{ runner.os }}-

      # =========================
      # DEPENDÊNCIAS LLVM 14
      # =========================
      - name: Install dependencies (LLVM 14)
        run: |
          sudo apt update -y
          sudo apt install -y \
            bc bison build-essential ccache curl flex git \
            libssl-dev libelf-dev libncurses5-dev \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            clang-14 lld-14 llvm-14 llvm-14-tools \
            zip wget neofetch
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s legacy

      # =========================
      # FIX BINÁRIOS LLVM 14
      # =========================
      - name: Fix LLVM 14 binary names
        run: |
          sudo ln -sf /usr/bin/clang-14         /usr/bin/clang
          sudo ln -sf /usr/bin/clang++-14       /usr/bin/clang++
          sudo ln -sf /usr/bin/llvm-ar-14       /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-14       /usr/bin/llvm-nm
          sudo ln -sf /usr/bin/llvm-objcopy-14  /usr/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-objdump-14  /usr/bin/llvm-objdump
          sudo ln -sf /usr/bin/llvm-strip-14    /usr/bin/llvm-strip
          sudo ln -sf /usr/bin/ld.lld-14        /usr/bin/ld.lld
          sudo ln -sf /usr/bin/ld.lld-14        /usr/bin/lld

          which clang
          which llvm-nm
          which ld.lld

      # =========================
      # ENV
      # =========================
      - name: Setup environment (LLVM 14)
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV

          echo "CC=ccache clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "AR=llvm-ar" >> $GITHUB_ENV
          echo "NM=llvm-nm" >> $GITHUB_ENV
          echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
          echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
          echo "STRIP=llvm-strip" >> $GITHUB_ENV

          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV

          ccache -M 10G
          ccache -C
          ccache -z
          clang --version

      # =========================
      # DEFCONFIG
      # =========================
      - name: Defconfig
        run: |
          rm -rf out
          make O=out guamp_defconfig

      # =========================
      # BUILD
      # =========================
      - name: Build kernel (LLVM 14)
        run: |
          make O=out -j$(nproc)
          ccache -s

      # =========================
      # ANYKERNEL
      # =========================
      - name: Build AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel
          rm -rf anykernel/.git anykernel/README.md

          cp out/arch/arm64/boot/Image.gz anykernel/ || \
          cp out/arch/arm64/boot/Image anykernel/

          cd anykernel
          zip -r9 ../AnyKernel3-Exynos9830.zip *

      # =========================
      # BOOT / DTB / DTBO
      # =========================
      - name: Build boot.img / dtb / dtbo
        run: |
          set -e
          export MODEL=r8s
          export BOARD=exynos9830

          mkdir -p build/out/$MODEL
          cp out/arch/arm64/boot/Image build/out/$MODEL/

          toolchain/mkdtimg cfg_create \
            build/out/$MODEL/dtb.img \
            build/dtconfigs/exynos9830.cfg \
            -d out/arch/arm64/boot/dts/exynos

          toolchain/mkdtimg cfg_create \
            build/out/$MODEL/dtbo.img \
            build/dtconfigs/$MODEL.cfg \
            -d out/arch/arm64/boot/dts/samsung

          pushd build/ramdisk
          find . ! -name . | LC_ALL=C sort | \
            cpio -o -H newc -R root:root | gzip > ../out/$MODEL/ramdisk.cpio.gz
          popd

          toolchain/mkbootimg \
            --board $BOARD \
            --kernel build/out/$MODEL/Image \
            --ramdisk build/out/$MODEL/ramdisk.cpio.gz \
            --dtb build/out/$MODEL/dtb.img \
            --header_version 2 \
            --pagesize 2048 \
            -o build/out/$MODEL/boot.img

      # =========================
      # ARTIFACTS
      # =========================
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boot-dtbo-dtb
          path: |
            build/out/r8s/boot.img
            build/out/r8s/dtb.img
            build/out/r8s/dtbo.img
            AnyKernel3-Exynos9830.zip
